# hlta-api, hlta-chroma
# hlta-api, hlta-chroma
x-common-vars: &common-vars
  TZ: Asia/Seoul
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  CHROMA_HOST: hlta-chroma
  CHROMA_PORT: 8000
  REDIS_HOST: ${REDIS_HOST}
  REDIS_PORT: ${REDIS_PORT}
  REDIS_PASSWORD: ${REDIS_PASSWORD}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
    
x-backend-defaults: &backend-defaults
  environment:
    <<: *common-vars
  image: hltutor-backend:20251105
  build:
    context: ./backend
    dockerfile: api.Dockerfile
  restart: unless-stopped
  working_dir: /app
  networks: [hlta_network]
  env_file:
    - .env
  volumes:
    - ./backend:/app:rw 
    - ./logs:/app/logs:rw
    - /data/storage:/data/storage:rw
    - /opt/hlta/tutorchroma:/tmp/tutorchroma
    - /data/storage/edu/manualdownload:/app/tutor/download_files/manual_test:rw
    # - /opt/hlta/backend/chromadb_source:/app/chromadb_source  # 문제발생에 따른파일마운트시 필요 

networks:
  hlta_network:
    name: hlta_network

services:
  hlta-redis:
    image: redis:7-alpine
    container_name: hlta-redis
    restart: unless-stopped
    networks: [hlta_network]
    # Redis 서버에 패스워드 설정 적용
    command: redis-server --requirepass ${REDIS_PASSWORD}
    expose: ["6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]    
      # test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  hlta-api:
    <<: *backend-defaults  
    container_name: hlta-api
    extra_hosts:
      - "host.docker.internal:host-gateway"    
    # env_file:
    #   - .env
    ports:
      - "8085:8085"
    command: ["/usr/bin/dumb-init", "--", "uvicorn", "server:app", "--reload", "--host", "0.0.0.0", "--port", "8085", "--log-config", "/app/logging.ini"]
    healthcheck:
      test: [ "CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8085/health\").getcode() == 200' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # ChromaDB 서비스가 건강(healthy) 상태일 때까지 기다리도록 의존성 설정
    depends_on:
      hlta-chroma:
        condition: service_healthy
      hlta-redis:
        condition: service_healthy

  hlta-worker:
    <<: *backend-defaults
    container_name: hlta-worker
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["/usr/bin/dumb-init", "--", "celery", "-A", "tasks", "worker", "--loglevel=info"]
    depends_on:
      hlta-redis:
        condition: service_healthy
      hlta-chroma:
        condition: service_healthy

  hlta-chroma:
    container_name: hlta-chroma
    image: chromadb/chroma
    restart: unless-stopped
    networks: [hlta_network]
    # 호스트의8002-컨테이너의 8000로, 외부에선 localhost:8002로, 내부(hlta-api 등)에선 hlta-chroma:8000으로 접근
    ports:
      - "8002:8000"
    # 영구 데이터 저장을 위한 볼륨 설정
    volumes:
      # - chroma_data:/Data/chroma_server_db
      - chroma_data:/data
    environment:
      <<: *common-vars
      IS_PERSISTENT: 'TRUE'
      PERSIST_DIRECTORY: /data
      CHROMA_SERVER_AUTH_PROVIDER: chromadb.auth.impl.pass.PassHeaderProvider
      # 인증 없이 사용 (개발환경)
    # ChromaDB 헬스체크 설정 (컨테이너의 준비 상태를 확인)
    healthcheck:
      test: ["CMD-SHELL", "/bin/bash -c 'cat < /dev/null > /dev/tcp/localhost/8000' || exit 1"]    
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      
# --- 3. 볼륨 정의 ---
# 영구 데이터 저장을 위한 명명된 볼륨을 정의합니다.
volumes:
  chroma_data:
    # hlta-chroma 서비스가 벡터 데이터를 저장할 볼륨
